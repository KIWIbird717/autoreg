# Autoreg backend documentation

## Введение

#### Обзор

Данный документ описывает архитектуру и функциональные особенности backend-сервиса проекта "Autoreg". Backend-сервис обеспечивет централизованное управление данными и взаимодействие с пользователя с sms-сервисами и базой данных.

#### Основные Функции

- **Регистрация и Авторизация Пользователей**: Сервис предоставляет возможности для регистрации новых пользователей, а также их авторизации.
- **Интеграция с SMS-сервисами**: Особое внимание уделено интеграции с рядом SMS-сервисов, таких как "sms-man", "5sim", "sms-activate" и других.

#### Технологии

- **MongoDB и Mongoose**: Для хранения и управления данными используется база данных MongoDB с библиотекой Mongoose.
- **TypeScript и Express**: Проект разработан с использованием TypeScript. Кастомная настройка роутов реализована на базе фреймворка Express, обеспечивая гибкость и масштабируемость в обработке запросов.

## Структура проекта

├── .DS_Store
├── .env
├── .gitignore
├── assets
├── nodemon.json
├── package-lock.json
├── package.json
├── public
├── README.md
├── src
│ ├── global-type.d.ts
│ ├── index.ts
│ ├── middlewares
│ ├── routes **# api эндпоинты**
│ │ ├── echo.router.ts
│ │ ├── errorList.router.ts
│ │ ├── index.router.ts
│ │ ├── moduleSender
│ │ ├── newAccountsFolder
│ │ ├── newUser
│ │ ├── parsingFolder
│ │ ├── telegram
│ │ └── updateUserData
│ ├── servises **# инициализация и экшены для используемых сервисов**
│ │ ├── ModuleSender **# Schema для ModuleSender**
│ │ ├── MongoDB **# MongoDb connection**
│ │ ├── RegisterUserDB **# Schema for user**
│ │ └── s3cloud **# initialize s3Cloud**
│ └── utils
│ ├── errorHandler.ts
│ ├── express
│ ├── hooks
│ ├── smsService
│ ├── telegram
│ └── webSocket
└── tsconfig.json

## Архитектура системы

- **Autorouting.** На данно проекте для контроля api роутов используется auto routing подобно тому, что испольщуется в nextjs с app router. На проекте в фолдере `BackEnd/src/routes` нужно создать папку с любым названием и создать файл с любым названием, например `rout.ts`. После чего в этом файле нужно создать эндпоинт по примеру ниже. В таком файле можно создать несколько эндпоинтов, а также эндпоинт с разными методами (GET, POST, UPDATE и т.д.)

```ts
// BackEnd/src/routes/test
import { Router } from "express";

const router = Router();

/**
 * Можно создать любой роут, например /my-post-route
 * и ваш роут будет доступен по эндпоинту {{baseUrl}}/test/my-post-route,
 * или можно оставить пустую строку,
 * тогда роут будет доступен по эндпоинту {{baseUrl}}/test
 */
router.post("/my-post-route", () => {
  // логика для вашего роута
});

export default router; // Обязательно экспортировать router по дефолту
```

- **Error handler**. Данный хендлер расположен в `BackEnd/src/utils/errorHandler.ts`. Он обработывает и логирует ошибоки в backend приложении "Autoreg". Он отвечает за запись информации об ошибках в файлы журналов, которые расположены в фолдере `/logs`.
  - При возникновении ошибки, если она отмечена как тип `"error"`, обработчик сохраняет информацию об ошибке в соответствующий файл журнала. Данные включают время возникновения ошибки, сообщение об ошибке и стек вызовов.
  - Если при возникновении ошибки указан электронный адрес пользователя, обработчик также записывает информацию об ошибке в базу данных, связанную с конкретным пользователем.

## Работа с базой данных

#### Обзор

Backend проекта "Autoreg" использует удаленную базу данных MongoDB, развернутую на серверах MongoDB через их официальный сайт.

#### Управление Базой Данных

- **Интеграция с Mongoose**: Управление данными в MongoDB осуществляется через библиотеку Mongoose
- **Подключение к БД**: Подключение к базе данных происходит в файле `mongoDb.servise.ts`, который находится по пути `BackEnd/src/servises/MongoDB`. Ссылка на удаленную базу данных MongoDB `DB_URL` находится в `.env` файле

#### Структура и Схемы Базы Данных

- **Расположение Схем**: Все схемы для базы данных хранятся в папках `ModuleSender` и `RegisterUserDB`, расположенных в `BackEnd/src/servises`.
- **Типы для Схем**: Типы данных для схем определены в файлах, таких как `types.d.ts`.

#### Обработка и Логирование

- **Логирование Событий**: В `mongoDb.servise.ts` также реализованы обработчики событий для логирования различных событий, связанных с базой данных, таких как `upload`, `error` и `connection`.

## Описание эндпоинтов

### Описание Эндпоинтов для Создания Новой Рассылки в Telegram

Файл `createNewDistribution.ts`, расположенный в `BackEnd/src/routes/moduleSender`, содержит два роута, отвечающих за создание новой рассылки по телеграм-чатам. Эти роуты обеспечивают запись информации о рассылке в базу данных и загрузку изображений для рассылки в s3 bucket. После этого микросервис для рассылок (реализованный на Python) запускает рассылку.

#### Роут `/new-distribution`

- **Цель**: Этот эндпоинт предназначен для записи данных о новой рассылке в базу данных. Он принимает информацию о рассылке, включая ее параметры и содержание, и сохраняет эти данные для дальнейшей обработки.
- **Описание**: Пользователь отправляет данные о рассылке, такие как название, описание, целевые пользователи, боты, используемые для рассылки, и другую соответствующую информацию. Эти данные записываются в базу данных, готовясь к выполнению на микросервисе рассылок.
- **Обработка**: После получения данных роут обрабатывает их и сохраняет в соответствующую коллекцию в базе данных. В случае успешной обработки возвращается подтверждение, а при возникновении ошибок – 500 статус

#### 2. Роут `/new-distribution-images`

- **Цель**: Этот эндпоинт задействован для загрузки изображений, используемых в рассылке, в s3 bucket. Он обеспечивает хранение медиафайлов, которые будут использоваться в рассылке.
- **Описание**: Пользователь отправляет изображения, которые необходимо включить в рассылку. Этот роут принимает файлы изображений и загружает их в s3 bucket, предоставляя URL-адреса для доступа к этим изображениям в рассылке.
- **Обработка**: Изображения обрабатываются и загружаются в s3 bucket. Роут возвращает URL-адреса загруженных изображений, которые затем могут быть использованы в телеграм-рассылке.

### Описание Эндпоинтов для Манипуляции Папками Телеграм Ботов

В папке `BackEnd/src/routes/newAccountsFolder` находятся три файла, каждый из которых содержит эндпоинт, отвечающий за определенные операции с папками, содержащими информацию о спаршенных телеграм аккаунтах. Эти операции включают создание, обновление и удаление папок.

#### 1. Эндпоинт `/add-accounts-to-user` (Файл: `addNewAccountsFolder.route.ts`)

- **Цель**: Добавление телеграм ботов в соответствующую папку пользователя.
- **Описание**: Этот эндпоинт принимает информацию о папке и аккаунтах, которые необходимо добавить. Он ищет пользователя по email, затем находит соответствующую папку по ключу и добавляет в нее аккаунты.
- **Обработка**: После успешного добавления аккаунтов в папку в базе данных, эндпоинт возвращает сообщение об успешном выполнении операции.

#### 2. Эндпоинт `/add-new-folder` (Файл: `addNewFolder.route.ts`)

- **Цель**: Создание новой папки для хранения телеграм ботов в базе данных.
- **Описание**: Принимает данные для создания новой папки, включая название и описание. После проверки на существование пользователя, добавляет новую папку в его профиль.
- **Обработка**: При успешном создании папки, возвращает информацию о новой папке и обновленный список папок пользователя.

#### 3. Эндпоинт `/delete-accounts-folder` (Файл: `deleteFolder.route.ts`)

- **Цель**: Удаление существующей папки из базы данных.
- **Описание**: Этот эндпоинт удаляет папку по заданному ключу. Он находит пользователя по email и удаляет указанную папку из его списка.
- **Обработка**: После удаления папки, возвращает обновленный список папок пользователя и подтверждение об успешном удалении.

### Описание Эндпоинтов для Управления Пользователями

В папке `BackEnd/src/routes/newUser` находятся два ключевых эндпоинта для управления пользователями: один для регистрации новых пользователей и другой для их логина.

#### 1. Эндпоинт `/registration` (Файл: `addNewUserToBD.route.ts`)

- **Цель**: Регистрация нового пользователя в системе.
- **Описание**: Этот эндпоинт обрабатывает регистрацию новых пользователей. При регистрации создается новый пользователь в базе данных и генерируется JWT-refresh токен. Если пользователь с введенными данными (имя, почта, пароль) уже существует, происходит автоматический логин.
- **Обработка**: Проверяется наличие пользователя в базе данных. Если он уже существует и введенные данные совпадают, пользователь авторизуется. В противном случае создается новая учетная запись. В ответ отправляется JWT-refresh и данные пользователя.

#### 2. Эндпоинт `/login` (Файл: `loginUser.route.ts`)

- **Цель**: Логин существующего пользователя в системе.
- **Описание**: Этот эндпоинт позволяет существующим пользователям входить в систему. Он проверяет существование пользователя и корректность введенного пароля.
- **Обработка**: После проверки пользователя и пароля генерируется новый JWT-рефреш токен. В случае успешного входа пользователю отправляются его данные и токен. Если данные неверны, возвращается соответствующая ошибка.

### Описание Эндпоинтов для Управления Папками Спаршенных Телеграм Аккаунтов

#### Файл: `ParsingFolder.ts` (Путь: `BackEnd/src/routes/parsingFolder`)

В этом файле содержатся три эндпоинта, отвечающих за создание, получение и удаление папок, предназначенных для хранения информации о спаршенных телеграм аккаунтах.

#### 1. Эндпоинт `/add-new-folder`

- **Цель**: Создание новой папки для спаршенных телеграм аккаунтов.
- **Описание**: Принимает данные пользователя и параметры новой папки. Папка добавляется в базу данных к соответствующему пользователю.
- **Обработка**: При успешном создании папки возвращает подтверждение. В случае ошибки – сообщение об ошибке.

#### 2. Эндпоинт `/get-pasing-folders/:mail`

- **Цель**: Получение списка папок с парсинговыми данными.
- **Описание**: По запросу с электронной почтой пользователя возвращает список всех его папок, содержащих спаршенные данные.
- **Обработка**: Возвращает список папок пользователя. Если пользователь не найден, возвращается сообщение об ошибке.

#### 3. Эндпоинт `/delete-parsing-folder`

- **Цель**: Удаление папки с спаршенными телеграм аккаунтами.
- **Описание**: Этот эндпоинт позволяет удалять существующие папки. Принимает данные пользователя и ключ удаляемой папки.
- **Обработка**: Удаляет указанную папку из профиля пользователя. В случае успешного удаления возвращает подтверждение, в случае ошибки – соответствующее сообщение.

### Описание Эндпоинтов в Папке `telegram` (Путь: `BackEnd/src/routes/telegram`)

Эти эндпоинты обеспечивают получение данных по используемым sms-сервисам на проекте.

#### Файл: `registerTelegram.router.ts`

- **Эндпоинт `/manual/add-code`**: Предназначен для ручного добавления кода от SMS-сервиса при регистрации пользователя в Telegram. Этот роут в настоящее время не используется в проекте.
  - **Описание**: Позволяет пользователю вручную ввести код из SMS-сообщения, который требуется для завершения регистрации в Telegram через SMS-сервис.
  - **Обработка**: При получении кода, он передается в функцию `addCodeToWaitingForVerify`, которая обрабатывает его для дальнейшей верификации пользователя.

#### Файл: `smsActivate.router.ts`

- **Эндпоинт `/get-service`**: Предоставляет список используемых SMS-сервисов на проекте.

  - **Описание**: Возвращает статический список SMS-сервисов, используемых для регистрации Telegram-аккаунтов, хранящийся в `smsActivate.ts`.
  - **Обработка**: Отправляет пользователю список доступных SMS-сервисов.

- **Эндпоинт `/get-country`**: Возвращает список стран, доступных для бронирования временных Telegram-аккаунтов.

  - **Описание**: Проверяет доступность стран в определенном SMS-сервисе и предоставляет список стран, доступных для выбора пользователями.
  - **Обработка**: При успешном запросе возвращает список стран, поддерживаемых выбранным SMS-сервисом.

- **Эндпоинт `/get-balance`**: Предоставляет информацию о текущем балансе на всех используемых SMS-сервисах.

  - **Описание**: Возвращает баланс пользователя в конкретном SMS-сервисе.
  - **Обработка**: Обрабатывает запрос пользователя и возвращает информацию о его балансе на выбранном SMS-сервисе.

- **Эндпоинт `/get-available-phones`**: Получение списка доступных номеров телефонов на каждом SMS-сервисе.

  - **Описание**: Позволяет пользователю узнать доступные номера телефонов для бронирования на выбранном SMS-сервисе в конкретной стране.
  - **Обработка**: Возвращает список доступных номеров на выбранном SMS-сервисе в указанной стране.

### Описание Эндпоинта `/update-apphash-appid` в Папке `updateUserData` (Путь: `BackEnd/src/routes/updateUserData`)

#### Файл: `updateAppHashId.ts`

Этот файл содержит эндпоинт, который отвечает за обновление данных пользователя, включая `appHash` и `appId`, в базе данных.

#### Эндпоинт `/update-apphash-appid`

- **Цель**: Обновление информации о `appHash` и `appId` для сохраненного пользователя в базе данных.
- **Описание**: Этот эндпоинт принимает электронную почту пользователя (`userMail`), а также новые значения `appHash` и `appId`. Затем он обновляет эти данные в профиле пользователя в базе данных.
- **Обработка**: Используется функция `updateUser`, которая находит пользователя по электронной почте и обновляет указанные данные. После успешного обновления возвращается обновленный профиль пользователя. В случае ошибки или если пользователь не найден, возвращается соответствующее сообщение об ошибке.

#### Функция `updateUser`

- **Описание**: Функция `updateUser` используется для обновления данных пользователя в базе данных. Она принимает электронную почту пользователя и объект с данными для обновления.
- **Пример Использования**:

```ts
updateUser("123@mail.ru", { nick: "Oleg", password: "newpassword" }).then(
  (updatedUser) => {
    if (updatedUser) {
      // updated user data
    } else {
      // User not found'
    }
  }
);
```

- **Обработка**: Функция ищет пользователя в базе данных по электронной почте и обновляет данные согласно предоставленному объекту. Возвращает обновленные данные пользователя или `null`, если произошла ошибка.
